## 技術資料: 写真アルバムアプリ

### 1. 概要

このWebアプリケーションは、ユーザーがデジタル写真を整理し、カスタマイズ可能なアルバムを作成するためのツールです。主な機能として、写真とコメントの追加、アルバム全体のタイトル・サブタイトル設定、各要素のフォント調整、複数ページの管理、PDF印刷、そしてアルバムデータのJSON形式でのエクスポート・インポートが含まれます。最新の更新では、写真のプレビューをクリックすると、その画像を拡大表示し、関連するコメントも同時に表示するモーダルウィンドウ機能が追加されました。

### 2. ファイル構成

*   `写真アルバムアプリ.html`: アプリケーションの全てのHTML、CSS、JavaScriptコードを含む単一ファイルです。

### 3. HTML構造 (`写真アルバムアプリ.html`)

アプリケーションのUIは、以下の主要なセクションに分かれています。

*   **`<head>`**
    *   `<meta charset="UTF-8">`: 文字エンコーディングをUTF-8に設定します。
    *   `<meta name="viewport" ...>`: レスポンシブデザインのためのビューポート設定です。
    *   `<title>`: ブラウザのタブに表示されるページタイトルです。
    *   `<style>`: アプリケーション全体のスタイルを定義するCSSが含まれます。

*   **`<body>`**
    *   **`.main-layout-container`**: アプリケーション全体のコンテナで、Flexboxを用いてコントロールパネルとアルバムコンテンツペインを左右に配置します。
    *   **`.control-panel` (左側)**:
        *   **`.title-input-area`**: メインタイトルとサブタイトルのテキスト入力フィールド (`#mainTitleInput`, `#subtitleInput`) を含みます。
        *   **`.font-settings-area` (タイトル)**: メインタイトルとサブタイトルのフォントファミリー (`<select>`) およびフォントサイズ (`<input type="number">`) を設定するUIです。
        *   **`.font-settings-area` (メモ)**: メモ（コメント）のフォントファミリー (`<select>`) およびフォントサイズ (`<input type="number">`) を設定するUIです。
        *   **`.button-area`**:
            *   **`#addPageButton`**: 新しいアルバムページを追加するボタン。
            *   **`#printButton`**: 現在のアルバム内容をPDFとして印刷するボタン。
            *   **`#jsonFileInput`**: JSONファイルを読み込むための非表示のファイル入力 (`<input type="file">`) と、それに関連付けられたスタイル付きのラベル (`.file-label`)。
            *   **`#downloadJsonButton`**: 現在のアルバムデータをJSONファイルとしてダウンロードするボタン。
            *   **`#initializeButton`**: アルバムの内容を初期状態に戻すボタン。
    *   **`.album-content-pane` (右側)**:
        *   **`#pages-container`**: JavaScriptによって動的に生成される各アルバムページ (`.print-page`) が格納されるコンテナです。
    *   **`#imageModal` (モーダルウィンドウ)**:
        *   選択した画像を拡大表示するためのオーバーレイコンテナです。
        *   `<span class="modal-close">`: モーダルを閉じるためのボタン（`&times;`）。
        *   `<img class="modal-content" id="modalImage">`: 拡大表示される画像。
        *   `<div id="caption" class="modal-caption">`: 拡大画像に関連するコメントを表示する領域。

### 4. CSSスタイル (`<style>`タグ内)

#### 4.1. 全体レイアウト

*   `body`: 基本フォント、背景色、Flexboxの親として設定し、最小の高さを確保。
*   `.main-layout-container`: コントロールパネルとコンテンツペインを横並びに配置するFlexboxコンテナ。
*   `.control-panel`: 左側の固定幅パネル。`max-height`と`overflow-y: auto`でスクロール可能にし、大量の設定項目にも対応。スクロールバーのカスタムスタイルも定義。
*   `.album-content-pane`: 右側のメインコンテンツエリア。`flex: 1`で利用可能な幅を全て使用し、`max-height`と`overflow-y: auto`でスクロール可能。

#### 4.2. コントロールパネル内のUI要素

*   `.title-input-area`, `.font-settings-area`: 入力フィールドとラベルを縦方向に並べ、背景色や角丸を適用。
*   `input`, `select`, `textarea`: フォーム要素の基本的なスタイル（幅、パディング、ボーダー、フォントサイズ）。
*   `.button-area button`: 各種ボタンの共通スタイル（パディング、角丸、カーソル）。
*   `#printButton`, `#addPageButton`, `#initializeButton`, `#downloadJsonButton`: 各ボタンに個別の背景色とホバー効果。
*   `.file-label`: ファイル入力ボタンを一般的なボタンのように見せるためのスタイル。

#### 4.3. アルバムコンテンツの表示

*   `.print-page`: 各アルバムページを表し、A4用紙のサイズ（幅210mm）をシミュレート。中央配置、シャドウ、パディング。`position: relative`はページ番号の絶対配置のため。
*   `.page-title`: アルバム全体のタイトルとサブタイトルのスタイル（中央寄せ、色、フォントスタイルはJSで動的に適用）。
*   `.page-title .page-subtitle-display`: サブタイトルを新しい行に表示するためのスタイル。
*   `.page-number-display`: ページ番号の絶対配置と基本的なフォントスタイル。
*   `.page-content`: 各ページ内の写真エントリーを縦方向に配置するFlexboxコンテナ。
*   `.photo-entry`: 個々の写真項目。写真プレビューとコントロールを横並びに配置するFlexbox、ボーダー、パディング。
*   `.photo-preview`: 写真のプレビュー表示エリア。固定高さ、ボーダー、画像がコンテナに収まるように設定。`cursor: pointer`でクリック可能であることを示します。
*   `.photo-preview img`: 画像がプレビューエリア内で最大限に表示されるように設定。
*   `.photo-controls`: ファイル入力とコメント入力欄を含むエリア。
*   `.photo-controls input[type="file"]`: ファイル選択ボタンのスタイル。
*   `.photo-controls textarea`: コメント入力欄のスタイル（高さ、パディング、リサイズ可否）。

#### 4.4. モーダルウィンドウのスタイル (新規/更新)

*   `.modal`: モーダルの基本的なスタイル。初期状態では`display: none`で非表示。`position: fixed`で画面に固定し、`z-index: 1000`で最前面に表示。半透明の黒い背景 (`background-color: rgba(0,0,0,0.9)` )。
*   `.modal-content`: 拡大表示される画像のスタイル。`margin: auto`で中央配置。
    *   `width: 90%`, `max-width: 90vw`, `max-height: 90vh`: **以前の80%から90%に拡大し、ビューポートの幅と高さに対する最大値も設定することで、より大きく画像が表示されるようになりました。**
    *   `object-fit: contain`: 画像のアスペクト比を維持しつつ、コンテナ内に収まるようにします。
*   `.modal-caption`: 拡大画像の下に表示されるコメントのスタイル。
    *   `width: 90%`, `max-width: 90vw`: **画像の幅に合わせて90%に拡大。**
    *   `max-height: 150px`, `overflow-y: auto`: 長いコメントでもスクロールして表示できるようにします。
*   `.modal-close`: モーダルを閉じるための`&times;`ボタンのスタイル。絶対配置で右上に表示し、大きなフォントサイズとホバー効果で使いやすくします。
*   `@keyframes zoom`: モーダルが開くときにズームインするアニメーション効果。
*   `@media only screen and (max-width: 768px)`: レスポンシブデザインのためのメディアクエリ。**以前の700pxから768pxにブレークポイントを調整し、より広い範囲のモバイルデバイスでモーダルが画面いっぱいに表示されるように`width: 95%`に設定しています。**

#### 4.5. 印刷用スタイル (`@media print`)

*   `@media print`: 印刷時に適用されるスタイル。
*   `.control-panel`: 印刷時には非表示。
*   `.album-content-pane`: 最大高さを解除し、スクロールを無効化。
*   `.print-page`: ページ区切り (`page-break-after: always`) を適用し、余白を調整。
*   `.photo-controls input[type="file"]`: 印刷時には非表示。
*   `.photo-preview`, `.photo-controls textarea`: 印刷時のボーダーや高さ、フォントサイズを調整。`.photo-preview img`の`cursor`も`default`に変更され、クリック可能であることを示さなくなります。

### 5. JavaScript機能 (`<script>`タグ内)

#### 5.1. グローバル変数

*   `entry_id_counter`: 各写真項目にユニークなIDを付与するためのカウンター。
*   `page_number_counter`: ページ番号を管理するカウンター。
*   主要なDOM要素への参照（`mainTitleInput`, `subtitleInput`, 各フォント設定入力、`pagesContainer`など）は`DOMContentLoaded`イベント内で設定されます。
*   モーダルウィンドウ関連のDOM要素への参照 (`imageModal`, `modalImage`, `modalCaption`, `modalClose`) も同様に設定されます。

#### 5.2. 関数群

*   **`setupImagePreview(imageInput, imagePreview)`**
    *   `imageInput` (`<input type="file">`) の`change`イベントを監視します。
    *   ファイルが選択されると`FileReader`を使用して画像を読み込み、`imagePreview` (`<img>`) の`src`に設定して表示します。

*   **`createPhotoEntryElement(imageData = '', commentText = '')`**
    *   新しい`.photo-entry` `div`要素を作成し、ユニークなIDを付与します。
    *   写真プレビュー (`<img>`) とコメント入力欄 (`<textarea>`) を含みます。
    *   `imageData`と`commentText`が指定されている場合（JSONからのロード時など）は初期値を設定します。
    *   **更新点: `<img>`要素にクリックイベントリスナーを追加。**
        *   画像がクリックされると、`imageModal`の`display`スタイルを`block`に設定してモーダルを表示します。
        *   クリックされた画像の`src`を`modalImage.src`に設定し、関連するコメントを`modalCaption.textContent`に設定します。
        *   モーダルのコメント表示部分に、ユーザーが設定したメモフォントスタイルを適用します (`commentFontFamilyInput.value`, `commentFontSizeInput.value`から計算)。

*   **`updatePageTitles()`**
    *   現在のメインタイトル、サブタイトル、およびフォント設定をコントロールパネルから取得します。
    *   全ての`.print-page`要素を走査し、各ページのタイトルとページ番号を更新し、指定されたフォントスタイルを適用します。
    *   ページ番号 (`page_number_counter`) を現在のページ数に合わせて同期します。

*   **`updateCommentStyles()`**
    *   コントロールパネルで設定されたメモのフォントファミリーとフォントサイズを取得します。
    *   全ての`.photo-controls textarea`要素を走査し、その`fontFamily`と`fontSize`スタイルを更新します。

*   **`createNewPageElement(photoEntriesData = null)`**
    *   `page_number_counter`をインクリメントし、新しい`.print-page` `div`要素を作成します。
    *   ページタイトルとページ番号表示要素を初期化し、`page-content`コンテナを追加します。
    *   `photoEntriesData`が提供されている場合（JSONからのロード時）、そのデータに基づいて4つの写真項目を生成します。それ以外の場合は、デフォルトで4つの空の写真項目を生成します。
    *   新しく追加された写真項目内のファイル入力フィールドに対し、`setupImagePreview`を呼び出してイベントリスナーを設定します。
    *   `updatePageTitles()`と`updateCommentStyles()`を呼び出し、全てのページのタイトルとコメントスタイルが最新の状態であることを保証します。

*   **`getAlbumData()`**
    *   現在のアルバム全体のデータ（メインタイトル、サブタイトル、各フォント設定、各ページの画像データとコメント）をJavaScriptオブジェクトとして収集し、返します。画像データはBase64エンコードされた文字列として保存されます。

*   **`loadAlbumDataIntoApp(albumData)`**
    *   引数として受け取った`albumData`オブジェクトに基づいて、アルバムの状態を復元します。
    *   既存のページをクリアし、カウンターをリセットし、コントロールパネルの入力フィールドに値を設定します。
    *   `albumData.pages`の各データを使って`createNewPageElement`を呼び出し、アルバムページと写真項目を再構築します。
    *   タイトルとコメントのスタイルも更新します。

*   **`downloadAlbumAsJson()`**
    *   `getAlbumData()`で現在のアルバムデータを取得します。
    *   そのデータを`JSON.stringify()`で整形されたJSON文字列に変換します。
    *   `Blob`オブジェクトとして作成し、一時的なURLを生成してダウンロードリンク (`<a>`要素) を作成します。
    *   ファイル名にタイムスタンプを含めて、ダウンロードを実行します。

*   **`handleJsonFileUpload(event)`**
    *   `jsonFileInput`の`change`イベントハンドラです。
    *   選択されたファイルを`FileReader`でテキストとして読み込みます。
    *   読み込んだJSON文字列を`JSON.parse()`でオブジェクトに変換し、`loadAlbumDataIntoApp()`を呼び出してアルバムを復元します。エラーハンドリングも含まれます。

*   **`initializeAlbum(showConfirm = true)`**
    *   アルバムの内容を完全にクリアし、タイトルやフォント設定をデフォルト値に戻します。
    *   確認ダイアログ (`confirm()`) の表示を制御できます。
    *   初期状態として1つの空のページを生成します。

#### 5.3. `DOMContentLoaded`イベントリスナー

*   ページが完全にロードされた後に実行されるメインの初期化処理です。
*   全ての主要なDOM要素への参照を取得し、グローバル変数に格納します。
*   `initializeAlbum(false)`を呼び出し、確認なしで初期アルバム（1ページ）を生成します。
*   各入力フィールド (`mainTitleInput`, `subtitleInput`, 各種フォント設定) の`input`または`change`イベントに`updatePageTitles()`や`updateCommentStyles()`をバインドし、ユーザーの変更が即座にUIに反映されるようにします。
*   各ボタン (`addPageButton`, `printButton`, `downloadJsonButton`, `jsonFileInput`, `initializeButton`) に対応するイベントハンドラをバインドします。
*   **更新点: モーダルウィンドウの閉じるイベントリスナーを設定。**
    *   `modalClose` (`&times;`) をクリックするとモーダルを非表示にします。
    *   モーダルの背景部分 (`imageModal`自体) をクリックしてもモーダルが閉じるように設定します。

### 6. 主要機能の概要

1.  **アルバムタイトル・サブタイトル設定**: ユーザーがアルバム全体のメインタイトルとサブタイトルを入力し、リアルタイムでプレビューに反映されます。
2.  **フォント設定**: メインタイトル、サブタイトル、そして各写真のコメント（メモ）に対して、フォントファミリーとサイズを個別に設定できます。これらの設定もリアルタイムでUIに適用されます。
3.  **写真とコメントの管理**: 各ページは4つの写真エントリーを持ちます。ユーザーはファイル入力から画像をアップロードし、テキストエリアにコメントを入力できます。
4.  **ページ管理**: 「新しいページを追加」ボタンで、アルバムに新しい空のページを追加できます。各ページには自動的にページ番号が割り振られます。
5.  **PDF印刷**: 「PDFとして印刷」ボタンをクリックすると、ブラウザの印刷機能を利用して現在のアルバム内容をPDFとして出力できます。印刷時にはコントロールパネルが非表示になり、アルバムコンテンツが印刷向けに最適化されます。
6.  **JSONデータの保存・読み込み**:
    *   「JSONファイルをダウンロード」ボタンで、現在のアルバムの状態（タイトル、フォント設定、各写真の画像データとコメント）をJSONファイルとして保存できます。
    *   「JSONファイルを読み込む」ボタンで、以前保存したJSONファイルを読み込み、アルバムの状態を復元できます。
7.  **アルバムの初期化**: 「アルバムを初期化」ボタンで、現在のアルバム内容を全てクリアし、デフォルトの1ページに戻します。
8.  **画像拡大表示 (モーダルウィンドウ)**: **アルバム内の写真プレビュー画像をクリックすると、その画像と関連するコメントが画面中央に大きく表示されるモーダルウィンドウが開きます。これにより、細かい部分の確認やコメントの全体像を把握しやすくなります。**

### 7. 使用技術

*   **HTML5**: アプリケーションの骨格構造。
*   **CSS3**: スタイリング、レイアウト、レスポンシブデザイン（`@media print`含む）。
*   **JavaScript (ES6+)**: 動的なコンテンツ生成、イベントハンドリング、データ管理、DOM操作、ファイルI/O。

### 8. 今後の拡張性

*   **写真の削除/並べ替え機能**: 各写真エントリーやページの削除ボタン、ドラッグ＆ドロップによる並べ替え機能の追加。
*   **レイアウトオプション**: 1ページあたりの写真数や写真とテキストの配置パターンを複数選択できる機能。
*   **画像のクロップ/回転**: アップロードした画像の簡単な編集機能。
*   **テーマ/カラースキーム**: アルバムの見た目を変更できるプリセットテーマの追加。
*   **クラウドストレージ連携**: Google DriveやDropboxなどと連携してアルバムデータを保存・読み込む機能。
*   **Undo/Redo機能**: ユーザー操作を取り消し・やり直しできる機能。
*   **印刷プレビューの強化**: 印刷設定（用紙サイズ、向きなど）を詳細に指定できるUIの提供。